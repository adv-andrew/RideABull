<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Details - Ride A Bull</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
        }
    </style>
    <!-- Load the env-loader.min.js script which contains the API key -->
    <script src="env-loader.min.js"></script>
</head>
<body>
    <nav class="nav">
        <a href="rides.html" class="nav-logo">Ride A Bull</a>
    </nav>

    <div class="container">
        <div style="max-width: 800px; margin: 2rem auto;">
            <a href="rides.html" style="color: var(--primary-color); text-decoration: none; display: inline-block; margin-bottom: 1rem;">
                ‚Üê Back to Rides
            </a>

            <div id="rideDetails">Loading ride details...</div>
        </div>
    </div>

    <!-- Google Maps JavaScript API Script -->
    <script>
        let map;
        let directionsService;
        let directionsRenderer;

        function initMap() {
            if (!document.getElementById('map')) {
                console.log('Map element not found, waiting for ride details to load...');
                return;
            }

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            
            // Create a default map centered at Florida
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: { lat: 28.5383, lng: -81.3792 }, // Orlando, FL
            });
            
            directionsRenderer.setMap(map);
        }

        function updateRoute(origin, destination) {
            if (!directionsService || !directionsRenderer) {
                console.log('Directions service not initialized yet');
                return;
            }

            const request = {
                origin: origin.coordinates,
                destination: destination.coordinates,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    // Update distance and duration
                    document.getElementById('route-distance').textContent = leg.distance.text;
                    document.getElementById('route-duration').textContent = leg.duration.text;
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }

        // Function to reinitialize map
        function reinitializeMap(ride) {
            initMap();
            if (ride && ride.origin && ride.destination) {
                updateRoute(ride.origin, ride.destination);
            }
        }
    </script>

    <script>
        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) {
                return `Today, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return `Tomorrow, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                return date.toLocaleDateString() + ', ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to load ride details
        async function loadRideDetails() {
            const rideId = getUrlParameter('id');
            if (!rideId) {
                alert('No ride ID provided');
                window.location.href = 'rides.html';
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }

                const response = await fetch(`http://localhost:3000/api/rides/${rideId}`, {
                    headers: {
                        'Authorization': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch ride details');
                }

                const ride = await response.json();
                
                // Update the page with ride details
                document.getElementById('rideDetails').innerHTML = `
                    <div class="card" style="margin-bottom: 2rem;">
                        <h1>${ride.origin.name} ‚Üí ${ride.destination.name}</h1>
                        <div class="ride-meta" style="margin: 1rem 0;">
                            <span>üöó ${ride.driverId.name}</span>
                            <span>üïí ${formatDate(ride.startTime)}</span>
                            <span>üí∫ ${ride.availableSeats} seats left</span>
                            <span>üí∞ $${ride.pricePerSeat}/seat</span>
                            <span>üõ£Ô∏è <span id="route-distance">Calculating...</span></span>
                            <span>‚è±Ô∏è <span id="route-duration">Calculating...</span></span>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h2>Route Map</h2>
                        <div id="map"></div>
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h2>Pickup & Dropoff</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h3>Pickup</h3>
                                <p>üìç ${ride.origin.name}</p>
                            </div>
                            <div>
                                <h3>Dropoff</h3>
                                <p>üìç ${ride.destination.name}</p>
                            </div>
                        </div>
                    </div>

                    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 1rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0;">$${ride.pricePerSeat} per seat</h3>
                                <p style="margin: 0; color: #666;">${ride.availableSeats} seats available</p>
                            </div>
                            <button onclick="requestToJoin('${ride._id}')" class="btn">Request to Join</button>
                        </div>
                    </div>
                `;

                // Initialize map after the DOM is updated
                setTimeout(() => reinitializeMap(ride), 100);

            } catch (error) {
                console.error('Error loading ride details:', error);
                document.getElementById('rideDetails').innerHTML = `
                    <div class="card">
                        <p style="color: red;">Error loading ride details. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Function to request to join a ride
        async function requestToJoin(rideId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }

                const response = await fetch(`http://localhost:3000/api/rides/${rideId}/request`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Request sent successfully!');
                    window.location.href = 'rides.html';
                } else {
                    throw new Error(data.message || 'Failed to send request');
                }
            } catch (error) {
                alert('Error sending request: ' + error.message);
            }
        }

        // Load ride details when page loads
        document.addEventListener('DOMContentLoaded', loadRideDetails);
    </script>
    
    <!-- Load Google Maps JavaScript API -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCY7x3NFuD9HC97sGgghNZEUvREq2TRZE0&callback=initMap">
    </script>
</body>
</html>